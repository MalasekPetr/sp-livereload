{"version":3,"file":"PnPSpFxLiveReloaderApplicationCustomizer.js","sourceRoot":"","sources":["../../../src/extensions/pnPSpFxLiveReloader/PnPSpFxLiveReloaderApplicationCustomizer.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  BaseApplicationCustomizer,\n  PlaceholderContent,\n  PlaceholderName\n} from '@microsoft/sp-application-base';\n\nimport { lrs } from '../common/LiveReloaderService';\nimport LiveReloadBar from '../components/LiveReloadBar';\n\nimport { LogDebug, LogError } from '../common/Logger';\nimport styles from './PnPSpFxLiveReloaderApplicationCustomizer.module.scss';\n\nimport {\n  IReadonlyTheme,\n  ThemeChangedEventArgs,\n  ThemeProvider\n} from '@microsoft/sp-component-base';\n\n/**\n * If your command set uses the ClientSideComponentProperties JSON input,\n * it will be deserialized into the BaseExtension.properties object.\n * You can define an interface to describe it.\n */\nexport interface IPnPSPFxLiveReloaderApplicationCustomizerProperties {\n  // This is an example; replace with your own property\n  Bottom: string;\n  Top: string;\n}\n\n// SPFx v1.21+ uses /temp/build/manifests.js, earlier versions use /temp/manifests.js\nconst LIVE_RELOAD_CONNECTION_V121 = \"//localhost:4321/temp/build/manifests.js\";\nconst LIVE_RELOAD_CONNECTION_LEGACY = \"//localhost:4321/temp/manifests.js\";\n\n/** A Custom Action which can be run during execution of a Client Side Application */\nexport default class PnPSPFxLiveReloaderApplicationCustomizer\n  extends BaseApplicationCustomizer<IPnPSPFxLiveReloaderApplicationCustomizerProperties> {\n\n  _themeProvider!: ThemeProvider;\n  _themeVariant: IReadonlyTheme | undefined;\n  _styles!: CSSStyleDeclaration;\n  _placeholder: PlaceholderContent | undefined;\n  _liveReloaderBar!: LiveReloadBar;\n\n  private async checkLiveReloadStatus() {\n\n    const connectionResponse = await this._checkConnection();\n    // LogDebug('INIT LIVE RELOADER STATE\\n\\t', lrs, connectionResponse);\n\n    if (connectionResponse && connectionResponse.status === 200) {\n      lrs.state = { available: true, connected: lrs.connected, debugConnected: false };\n    } else {\n      lrs.state = { available: false, connected: false, debugConnected: false };\n    }\n\n    return Promise.resolve();\n\n  }\n\n  private setCSSVariables(theming: any) {\n\n    // request all key defined in theming\n    const themingKeys = Object.keys(theming);\n\n\n    if (!this._styles) {\n      const styleElement = document.createElement('div');\n      this._styles = styleElement.style;\n    }\n\n    // if we have the key\n    if (themingKeys !== null) {\n\n      // loop over it\n      themingKeys.forEach(key => {\n        // add CSS variable to style property of the web part\n        this._styles.setProperty(`--${key}`, theming[key])\n\n      });\n\n      if (this._styles) {\n        Object.assign(this._styles)\n      }\n\n    }\n\n  }\n\n  private async _checkConnection() {\n\n    // LogDebug('Try to fetch live reload connection');\n\n    // Try SPFx v1.21+ URL first, then fall back to legacy URL for older versions\n    try {\n      const liveReloadConnection = await fetch(LIVE_RELOAD_CONNECTION_V121) as Response;\n      if (liveReloadConnection.ok) {\n        return liveReloadConnection;\n      }\n    } catch {\n      LogDebug('SPFx v1.21+ connection not available, trying legacy URL...');\n    }\n\n    // Fall back to legacy URL (SPFx < v1.21)\n    try {\n      const liveReloadConnection = await fetch(LIVE_RELOAD_CONNECTION_LEGACY) as Response;\n      return liveReloadConnection;\n    } catch {\n      LogDebug('Connection not available');\n      return null;\n    }\n\n  }\n\n  private _renderStatusBar() {\n\n    if (!this._placeholder) {\n\n      // Use placement from localStorage (via lrs.placement), default is 'bottom'\n      const placeholderName = lrs.placement === 'top' ? PlaceholderName.Top : PlaceholderName.Bottom;\n\n      this._placeholder = this.context.placeholderProvider.tryCreateContent(\n        placeholderName,\n        { onDispose: this._onDispose }\n      );\n\n      // The extension should not assume that the expected placeholder is available.\n      if (!this._placeholder) {\n\n        LogDebug(`The expected placeholder (${lrs.placement}) was not found.`);\n\n        return;\n\n      }\n\n      if (this._placeholder.domElement) {\n\n        this._placeholder.domElement.setAttribute('style', this._styles.cssText);\n        this._placeholder.domElement.classList.add(styles.pnpLiveReloader);\n\n        this._liveReloaderBar = new LiveReloadBar(this._placeholder.domElement, this.context.manifest);\n\n        this._liveReloaderBar.setState();\n\n        this._placeholder.domElement.classList.add(styles.pnpLiveReloader);\n\n      }\n    }\n  }\n\n  private initThemes() {\n    // Consume the new ThemeProvider service\n    this._themeProvider = this.context.serviceScope.consume(ThemeProvider.serviceKey);\n\n    // If it exists, get the theme variant\n    this._themeVariant = this._themeProvider.tryGetTheme();\n\n    // If there is a theme variant\n    if (this._themeVariant) {\n\n      // we set transfer semanticColors into CSS variables\n      this.setCSSVariables(this._themeVariant.semanticColors);\n\n      this.setCSSVariables(this._themeVariant.palette);\n\n    }\n  }\n\n  public async onInit(): Promise<void> {\n\n    // Init Themes\n    this.initThemes();\n\n    // Init Live Reloader State\n    LogDebug(\"Current State :::\", lrs.state);\n\n    try {\n\n      await this.checkLiveReloadStatus();\n      this.context.placeholderProvider.changedEvent.add(this, this._renderStatusBar);\n\n    } catch (e) {\n\n      LogError('Debug Log', e);\n      throw new Error(e instanceof Error ? e.message : String(e));\n\n    }\n\n    this._themeProvider.themeChangedEvent.add(this,  this.onThemeChanged);\n\n    return Promise.resolve();\n\n  }\n\n  private onThemeChanged(args: ThemeChangedEventArgs): void {\n\n    if (!args) {\n      return;\n    }\n\n    if (args.theme) {\n\n      this.setCSSVariables(args.theme.semanticColors);\n      this.setCSSVariables(args.theme.palette);\n\n      if(this._placeholder){\n        this._placeholder.domElement.setAttribute('style', this._styles.cssText);\n      }\n\n\n    }\n\n  }\n\n  private _onDispose(): void {\n    console.log('[HelloWorldApplicationCustomizer._onDispose] Disposed custom top and bottom placeholders.');\n  }\n\n}\n"]}